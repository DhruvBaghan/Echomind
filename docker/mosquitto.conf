# ============================================
# EchoMind - Mosquitto MQTT Broker Configuration
# ============================================
# This configuration is for future IoT integration
# allowing real-time data collection from smart meters

# ===========================================
# General Settings
# ===========================================

# Unique identifier for this broker
# Used in bridging scenarios
# pid_file /var/run/mosquitto.pid

# User to run as (if started as root)
user mosquitto

# ===========================================
# Persistence Settings
# ===========================================

# Enable persistence for retained messages and subscriptions
persistence true
persistence_location /mosquitto/data/

# Autosave interval (seconds) - 0 means only save on shutdown
autosave_interval 300

# ===========================================
# Logging Settings
# ===========================================

# Log destination: stdout, stderr, syslog, topic, file
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout

# Log types to include
log_type error
log_type warning
log_type notice
log_type information

# Include timestamps in logs
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# Log connection events
connection_messages true

# ===========================================
# Listener Configuration
# ===========================================

# Default MQTT listener (unencrypted)
listener 1883
protocol mqtt

# WebSocket listener (for web clients)
listener 9001
protocol websockets

# Secure MQTT listener (uncomment for production)
# listener 8883
# protocol mqtt
# cafile /mosquitto/certs/ca.crt
# certfile /mosquitto/certs/server.crt
# keyfile /mosquitto/certs/server.key
# require_certificate false

# Secure WebSocket listener (uncomment for production)
# listener 9443
# protocol websockets
# cafile /mosquitto/certs/ca.crt
# certfile /mosquitto/certs/server.crt
# keyfile /mosquitto/certs/server.key

# ===========================================
# Security Settings
# ===========================================

# Allow anonymous connections (set to false for production)
allow_anonymous true

# Password file for authentication (uncomment for production)
# password_file /mosquitto/config/passwd

# Access control list (uncomment for production)
# acl_file /mosquitto/config/acl

# ===========================================
# Client Settings
# ===========================================

# Maximum number of client connections (-1 = unlimited)
max_connections -1

# Maximum inflight messages per client
max_inflight_messages 20

# Maximum queued messages per client
max_queued_messages 1000

# Maximum packet size (bytes)
max_packet_size 0

# Message size limit (bytes, 0 = default 256MB)
message_size_limit 0

# ===========================================
# Session Settings
# ===========================================

# Persistent client expiration (seconds, 0 = never expire)
persistent_client_expiration 0

# Clean session default for MQTT v5 clients
# set_tcp_nodelay true

# ===========================================
# Keep Alive Settings
# ===========================================

# Maximum keep alive interval (seconds)
max_keepalive 65535

# ===========================================
# Topic Settings for EchoMind
# ===========================================
# 
# Expected topic structure:
#
# echomind/+/electricity/consumption
#   - Electricity meter readings
#   - Payload: {"value": 1.5, "unit": "kWh", "timestamp": "2024-01-15T10:30:00Z"}
#
# echomind/+/water/consumption
#   - Water meter readings
#   - Payload: {"value": 50, "unit": "liters", "timestamp": "2024-01-15T10:30:00Z"}
#
# echomind/+/status
#   - Device status updates
#   - Payload: {"online": true, "battery": 85, "signal": -45}
#
# echomind/alerts/+
#   - System alerts (leak detection, high usage, etc.)
#   - Payload: {"type": "leak", "severity": "high", "message": "..."}
#
# echomind/commands/+
#   - Commands to devices (future use)
#
# Where + is the device/user ID

# ===========================================
# Retained Message Settings
# ===========================================

# Maximum retained messages (0 = unlimited)
# retained_max_messages 0

# Retained message size limit (bytes)
# retained_max_size 0

# ===========================================
# Bridge Configuration (for future use)
# ===========================================
# Bridges allow connecting to other MQTT brokers
# Useful for cloud connectivity

# Example bridge to cloud (uncomment and configure)
# connection echomind-cloud
# address cloud.echomind.io:8883
# topic echomind/# out 1
# topic echomind/commands/# in 1
# bridge_cafile /mosquitto/certs/cloud-ca.crt
# bridge_certfile /mosquitto/certs/client.crt
# bridge_keyfile /mosquitto/certs/client.key
# remote_username echomind-bridge
# remote_password ${BRIDGE_PASSWORD}
# notifications true
# notification_topic echomind/bridge/status
# keepalive_interval 60
# start_type automatic
# try_private true

# ===========================================
# System Settings
# ===========================================

# Include additional config files
# include_dir /mosquitto/config/conf.d

# ===========================================
# Notes for Production Deployment
# ===========================================
#
# 1. Enable TLS/SSL:
#    - Generate certificates
#    - Uncomment secure listener sections
#    - Set require_certificate based on needs
#
# 2. Enable Authentication:
#    - Create password file: mosquitto_passwd -c /mosquitto/config/passwd user1
#    - Set allow_anonymous false
#    - Uncomment password_file directive
#
# 3. Enable Authorization:
#    - Create ACL file with topic permissions
#    - Uncomment acl_file directive
#
# 4. For High Availability:
#    - Consider using MQTT broker clustering
#    - Or use a managed MQTT service
#
# 5. Monitoring:
#    - Enable $SYS topics for broker statistics
#    - Integrate with Prometheus/Grafana